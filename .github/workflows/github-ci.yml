---
#------------------------------------------------------------------------------
# Central GitHub CI
# Doc: https://docs.github.com/de/actions
#------------------------------------------------------------------------------
name: CDU CI

#------------------------------------------------------------------------------
# Token Permission
#------------------------------------------------------------------------------
permissions:
  actions: write
  checks: none
  contents: write
  deployments: none
  id-token: none
  issues: none
  discussions: none
  packages: none
  pages: write
  pull-requests: write
  repository-projects: none
  security-events: none
  statuses: none

defaults:
  run:
    shell: cmd

env:
  PYTHON_VERSION: 3.11.5
  PYTHON_ARCH: x64
  PYTHON_PACKAGE_INST_PATH: ./Documentation/Installation
  PYTHON_PACKAGE_INST_FILE: install_packages.bat
  DOXYGEN_OUTPUT_NAME: Output_Doxygen
  DOXYGEN_OUTPUT_PATH: ./Documentation/DoxygenCreator/Output_Doxygen
  BINARY_EXE_NAME: bin_Exe
  BINARY_SETUP_NAME: bin_Setup
  BINARY_PATH: ./Executable/bin

#--------------------------------------------------------------------------------
# WORKFLOW TRIGGER
#--------------------------------------------------------------------------------
on:
  push:
    branches:
      - master

#--------------------------------------------------------------------------------
# WORKFLOW JOBS
#--------------------------------------------------------------------------------
jobs:
  doc-Doxygen:
    runs-on: windows-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ env.PYTHON_ARCH }}
      - name: Install Packages
        working-directory: ${{ env.PYTHON_PACKAGE_INST_PATH }}
        run: ${{ env.PYTHON_PACKAGE_INST_FILE }}
      - name: Run PyPreprocessor
        working-directory: ./Test
        run: python py_preprocessor.py -p True
      - name: Run Doxygen
        working-directory: ./Documentation/DoxygenCreator
        run: python doxygen_creator.py
      - name: Upload Doxygen Output
        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.DOXYGEN_OUTPUT_NAME }}
          path: ${{ env.DOXYGEN_OUTPUT_PATH }}
  #------------------------------------------------------------------------------
  doc-Pages:
    needs: doc-Doxygen
    runs-on: windows-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Download Doxygen Output
        uses: actions/download-artifact@v3
        with:
          name: ${{ env.DOXYGEN_OUTPUT_NAME }}
          path: ${{ env.DOXYGEN_OUTPUT_PATH }}
      - name: Delete gh-pages branch
        if: inputs.documentation == 'clean publish'
        run: |
          git checkout gh-pages
          git push origin --delete gh-pages
      - name: Set up Python
        if: github.event_name == 'push'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          architecture: ${{ env.PYTHON_ARCH }}
      - name: Get prerelease status
        if: github.event_name == 'push'
        shell: powershell
        run: |
          $version = $(python -c "from Source.version import PRERELEASE_BUILD; print(PRERELEASE_BUILD)")
          echo "prerelease_version=$version" >> $env:GITHUB_ENV
      - name: Deploy to Github Pages
        if: (github.event_name != 'push') || (env.prerelease_version == 'false')
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.DOXYGEN_OUTPUT_PATH }}/html